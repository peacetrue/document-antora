= VirtualBox

本文简单介绍虚拟机 *VirtualBox* 的使用。以下操作在 **macOS Catalina 10.15.6 (19G73) ** 系统上完成 。

== 参考

* https://www.virtualbox.org/[官网^]
* https://www.cnblogs.com/mawanglin2008/articles/3656006.html[VirtualBox 实现内外网络互访问的配置^]

== 获取安装包

* 下载 https://download.virtualbox.org/virtualbox/6.1.18/VirtualBox-6.1.18-142142-OSX.dmg[VirtualBox-6.1.18]
* 使用【安装盘】中的 *VirtualBox-6.1.18-142142-OSX.dmg*

== 安装 Centos7

从【安装盘】中获取 *CentOS-7-x86_64-Minimal-2003.iso* （无界面版）。选择以下安装参数：

* 名称：centos7
* 类型：Linux
* 版本：Red Hat（64-bit）

安装完成后，设置账号为 *root*，密码为 *123456* 。

== 虚拟机连接外网

刚装好的系统无法连外网，需要配置启动时激活网卡。

[source%nowrap,bash]
----
# 编辑网卡
$ vi /etc/sysconfig/network-scripts/ifcfg-enp0s3
# 修改配置项 ONBOOT=yes

# 重启网络服务
service network restart
----

创建 *basic* 备份，该备份支持外网连接。

== 宿主机连接虚拟机

在虚拟机中操作十分不便，使用宿主机连接虚拟机后，在宿主机中操作虚拟机。默认情况下不支持从宿主机连接虚拟机，可以通过 *仅主机（Host-Only）网络* 模式实现。

=== 查看虚拟机网卡

image::VirtualBox/查看网关.png[]

* 名称：vboxnet0
* 网关地址：192.168.150.1
* 子网掩码：255.255.255.0

启用 DHCP 服务器，自动分配 IP 地址：

image::VirtualBox/启用DHCP.png[]

NOTE: 为了简化操作，这里没有配置静态 IP。

=== 查看宿主机网卡

使用命令 `ifconfig vboxnet0` 查看虚拟机在宿主机上的 *vboxnet0* 网卡：

[source%nowrap,bash]
----
$ ifconfig vboxnet0
vboxnet0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> mtu 1500
	ether 0a:00:27:00:00:00
	inet 192.168.150.1 netmask 0xffffff00 broadcast 192.168.150.255
----

=== 添加【网卡2】

image::VirtualBox/添加网卡2.png[]

* MAC 地址：0800277C8FC3 （08:00:27:7C:8F:C3）

使用命令 `ip addr` 查看虚拟机网络情况：

image::VirtualBox/添加网卡2后网络情况.png[]

* *网卡2* 使用网卡 *enp0s8*
* 动态分配的 IP 地址为：*192.168.150.3*

创建 *动态IP* 备份，该备份支持宿主机连接虚拟机。

=== 宿主机连接虚拟机

[source%nowrap,bash]
----
#配置免密登陆
$ ssh-keygen -t rsa
$ cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys
$ ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.150.3
----

虽然是动态分配的 IP ，使用中没有发现 IP 地址变化的情况。

=== 虚拟机之间通讯

复制一个虚拟机 *centos7 副本*，测试虚拟机之间的网络连接。使用中发现，复制出的新虚拟机 IP 地址依次递增。

. 登陆虚拟机 *centos7*：`ssh root@192.168.150.3`
. 登陆虚拟机 *centos7 副本*：`ssh root@192.168.150.4`
. 虚拟机 *centos7* 和 *centos7 副本* 之间，可以使用 IP *192.168.150.3* 和 *192.168.150.4* 相互连接

== 备份

之前已经准备了 2 个备份：

. *basic*：虚拟机可连接外网
. *动态IP*：宿主机可连接虚拟机

接下来再准备一些常用的备份。

=== 最新环境

基于【动态IP】备份，使用命令 `yum -y update` 更新系统到最新状态，然后创建【最新环境】备份，并备注日期 *2021-01-23* 。

=== 基础命令

[source%nowrap,bash]
----
#安装常用命令
$ yum install -y wget tree tcpdump vim htop net-tools lsof

# 配置 vim 显示行号
$ vim ~/.vimrc
# 追加 :set number
----

=== JDK8 备份

基于【动态IP】备份，创建一个含 JDK8 的备份：

[source%nowrap,bash]
----
$ yum install java-1.8.0-openjdk
$ java -version
openjdk version "1.8.0_275"
OpenJDK Runtime Environment (build 1.8.0_275-b01)
OpenJDK 64-Bit Server VM (build 25.275-b01, mixed mode)
#查找Java的路径
$ update-alternatives --config java

共有 1 个提供“java”的程序。

  选项    命令
-----------------------------------------------
*+ 1           java-1.8.0-openjdk.x86_64 (/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.275.b01-0.el7_9.x86_64/jre/bin/java)

#设置 JAVA_HOME
$ echo 'export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.275.b01-0.el7_9.x86_64/jre'>>~/.bash_profile
$ source ~/.bash_profile
$ echo $JAVA_HOME
/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.275.b01-0.el7_9.x86_64/jre
----

=== JDK13 备份

基于【基础命令】备份，创建一个含 JDK13 的备份：

[source%nowrap,bash]
----
#下载安装包
$ curl -O https://download.java.net/java/GA/jdk13/5b8a42f3905b406298b72d750b6919f6/33/GPL/openjdk-13_linux-x64_bin.tar.gz
#解压安装包
$ tar xvf openjdk-13_linux-x64_bin.tar.gz
#移动安装包
$ sudo mv jdk-13 /opt/
#创建快捷命令
$ sudo tee /etc/profile.d/jdk13.sh <<EOF
export JAVA_HOME=/opt/jdk-13
export PATH=\$PATH:\$JAVA_HOME/bin
EOF
$ source /etc/profile.d/jdk13.sh
$ echo $JAVA_HOME
/opt/jdk-13
$ java -version
openjdk version "13" 2019-09-17
OpenJDK Runtime Environment (build 13+33)
OpenJDK 64-Bit Server VM (build 13+33, mixed mode, sharing)
----

=== 总结

最终的备份链如下：

image::VirtualBox/备份树.png[]

////
=== 配置【网卡2】固定 IP

. cd /etc/sysconfig/network-scripts
. cp ifcfg-enp0s3 ifcfg-enp0s8
. vi ifcfg-enp0s8

[source%nowrap,properties]
----
DEVICE=enp0s8 #网卡名称
TYPE=Ethernet
ONBOOT=yes 设置为自动启动
BOOTPROTO=static #改为使用静态ip
IPADDR=192.168.150.2 #设置该虚拟机的ip地址，要与宿主机在一个网段，但是不能重名
NETMASK=255.255.255.0 #设置子网掩码，需与图 2-3一致
NM_CONTROLLED=yes
HWADDR=08:00:27:7C:8F:C3 #网卡的MAC地址，需与图 2 3中的MAC一致
#UUID=f4adafbc-322d-4dc8-b549-4291f1c04f01
----

////

